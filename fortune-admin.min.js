angular.module("templates-main",["/templates/directives/faEditable.html","/templates/directives/uml/canvas.html","/templates/views/mynavbar.html","/templates/views/resources.html","/templates/views/uml.html"]),angular.module("/templates/directives/faEditable.html",[]).run(["$templateCache",function(a){a.put("/templates/directives/faEditable.html",'<section>\n  <div ng-switch="schemaType">\n    <div ng-switch-when="String">\n      <a href="#" onaftersave="apply(value)" editable-text="value">{{value || \'Not set.\'}}</a>\n    </div>\n    <div ng-switch-when="Number">\n      <a href="#" onaftersave="apply(value)" editable-number="value">{{value || \'Not set.\'}}</a>\n    </div>\n    <div ng-switch-when="Date">\n      <a href="#" onaftersave="apply(value)" editable-date="value">{{value || \'Not set.\'}}</a>\n    </div>\n    <div ng-switch-when="Boolean">\n      <a href="#" onaftersave="apply(value)" editable-checkbox="value">{{value ? \'Yep\' : \'Nope\'}}</a>\n    </div>\n  </div>\n</section>')}]),angular.module("/templates/directives/uml/canvas.html",[]).run(["$templateCache",function(a){a.put("/templates/directives/uml/canvas.html",'<div id="umlcanvas">\n</div>')}]),angular.module("/templates/views/mynavbar.html",[]).run(["$templateCache",function(a){a.put("/templates/views/mynavbar.html",'<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation" bs-navbar>\n    <div class="container-fluid">\n        <div class="navbar-header">\n            <a class="navbar-brand" href="#"><b>Fortune Admin</b></a>\n        </div>\n        <div class="collapse navbar-collapse">\n            <ul class="nav navbar-nav">\n                <li class="dropdown">\n                    <a href="#" class="dropdown-toggle">Resources <b class="caret"></b></a>\n                    <ul class="dropdown-menu">\n                        <li ng-repeat="resource in resources"><a data-ng-href="{{ r(\'resource\', {name: pluralize(resource.name) }) }}">{{ pluralize(resource.name) }}</a></li>\n                    </ul>\n                </li>\n                <li><a data-ng-href="{{ r(\'uml_diagram\') }}">UML</a></li>\n            </ul>\n        </div>\n    </div>\n</nav>\n\n')}]),angular.module("/templates/views/resources.html",[]).run(["$templateCache",function(a){a.put("/templates/views/resources.html",'<section id="fortune-admin">\n  <fortune-admin-navbar></fortune-admin-navbar>\n  <h4 class="text-center">{{ parentResourceName | uppercase }} {{ parentId ? parentId + \' /\' : null}} {{plurResourceName | uppercase}}</h4>\n  <table class="table table-bordered">\n    <tr>\n      <th ng-repeat="(name, type) in currentResource.schema | filterLinks">{{name}}</th>\n      <th ng-repeat="(linkName, link) in links">{{ResourcesCtrl.resolveFieldName(linkName)}}</th>\n      <th>Actions</th>\n    </tr>\n    <tr ng-repeat="entity in data">\n      <td ng-repeat="(path, type) in currentResource.schema | filterLinks">\n        <fa-editable ng-model="entity[path]" path="path" resource-name="{{plurResourceName}}" resource-id="{{entity.id}}" schema-type="type"></fa-editable>\n      </td>\n      <td ng-repeat="(linkName, link) in links">\n        <div ng-if="ResourcesCtrl.linkToMany(linkName)">\n          <a ng-href="{{ fortuneAdminRoute(\'subresource\', {parent: plurResourceName, id: entity.id, name: link.type, inverse: ResourcesCtrl.resolveInverse(linkName)}) }}">Navigate to {{link.type}}</a>\n        </div>\n        <div ng-if="!ResourcesCtrl.linkToMany(linkName)">\n          <div ng-init="fname = ResourcesCtrl.resolveFieldName(linkName)"></div>\n          <!--Initialize links if they do not come from server-->\n          <div ng-init="entity.links = entity.links || {}"></div>\n          <fa-ref ng-model="entity.links[fname]" ref="currentResource.schema[fname]" resource-name="{{ plurResourceName }}" resource-id="{{ entity.id }}"></fa-ref>\n        </div>\n      </td>\n      <td>\n        <button type="button" ng-click="ResourcesCtrl.deleteRow($index, entity.id)" class="btn btn-xs btn-danger">Delete</button>\n      </td>\n    </tr>\n  </table>\n  <div class="col-md-3">\n    <div ng-hide="PK === \'id\'">\n      <label>Enter {{ PK }} for new {{ currentResource.name }}</label>\n      <input type="text" ng-model="PrimaryKey" ng-required="true" class="form-control"/>\n    </div>\n    <button type="button" ng-click="ResourcesCtrl.addRow(PrimaryKey)" class="btn btn-default btn-sm" ng-disabled="PK !== \'id\' && !PrimaryKey">Create new row</button>\n  </div>\n</section>')}]),angular.module("/templates/views/uml.html",[]).run(["$templateCache",function(a){a.put("/templates/views/uml.html",'<section id="fortune-admin">\n  <fortune-admin-navbar></fortune-admin-navbar>\n  <section ng-if="resources.length !== 0">\n    <div ng-if="render">\n      <div resources-canvas resources="resources"></div>\n    </div>\n  </section>\n</section>')}]),angular.module("fortuneAdmin",["templates-main",,"ui.bootstrap","xeditable","fortuneAdmin.Controllers","fortuneAdmin.Directives","fortuneAdmin.Services","fortuneAdmin.Uml"]).provider("fortuneAdmin",[function(){var a={},b=null,c={when:function(b,c,d){a[b]={url:c,params:d}},install:function(c){for(var d in a){var e=a[d],f=e.url,g=e.params;c.when(f,g)}b&&c.otherwise(b)}},d=window.CONFIG.fortuneAdmin;return{setApiHost:function(a){CONFIG.fortuneAdmin.baseEndpoint=a},setApiNamespace:function(a){CONFIG.fortuneAdmin.apiNamespace=a},html5Mode:function(a,b){CONFIG.fortuneAdmin.routing.html5Mode=!!a,CONFIG.fortuneAdmin.routing.urlPrefix=b||""},setAuthToken:function(a){CONFIG.fortuneAdmin.authToken=a},mountTo:function(a,b){c.when("uml_diagram",b+"/uml",{templateUrl:d.prepareViewTemplateUrl("uml"),controller:"UmlCtrl as UmlCtrl"}),c.when("resource",b+"/:name",{templateUrl:d.prepareViewTemplateUrl("resources"),controller:"ResourcesCtrl as ResourcesCtrl",resolve:{resources:["$q","$http",function(a,b){var c=a.defer(),e={params:{userAuthToken:CONFIG.fortuneAdmin.authToken}};return b.get(d.baseEndpoint+"/resources",e).success(function(a){c.resolve(a.resources)}),c.promise}],data:["$q","$http","$route",function(a,b,c){var e=c.current.params.name,f=a.defer(),g={params:{userAuthToken:CONFIG.fortuneAdmin.authToken}};return b.get(d.getApiNamespace()+"/"+e,g).success(function(a){f.resolve(a)}),f.promise}]}}),c.when("subresource",b+"/:parent/:id/:name/refby/:inverse",{templateUrl:d.prepareViewTemplateUrl("resources"),controller:"ResourcesCtrl as ResourcesCtrl",resolve:{resources:["$q","$http",function(a,b){var c=a.defer(),e={params:{userAuthToken:CONFIG.fortuneAdmin.authToken}};return b.get(d.baseEndpoint+"/resources",e).success(function(a){c.resolve(a.resources)}),c.promise}],data:["$q","$http","$route",function(a,b,c){var e=a.defer(),f=c.current.params.inverse,g=c.current.params.id,h=c.current.params.name,i={params:{userAuthToken:CONFIG.fortuneAdmin.authToken}};return b.get(d.getApiNamespace()+"/"+h+"?filter["+f+"]="+g,i).success(function(a){e.resolve(a)}),e.promise}]}}),c.install(a)},$get:function(){return{getRoute:function(b){return a[b]},replaceUrlParams:function(a,b){for(var c in b){var d=b[c];a=a.replace(":"+c,d)}return a},routeDefined:function(a){return!!this.getRoute(a)},routePath:function(a,b){var c=this.getRoute(a);return c=c?c.url:null,c&&b&&(c=this.replaceUrlParams(c,b)),CONFIG.fortuneAdmin.routing.html5Mode?c:"/#"+CONFIG.fortuneAdmin.routing.urlPrefix+c},setApiHost:function(a){CONFIG.fortuneAdmin.baseEndpoint=a},setApiNamespace:function(a){CONFIG.fortuneAdmin.apiNamespace=a},setAuthToken:function(a){CONFIG.fortuneAdmin.authToken=a}}}}}]).run(["$rootScope","$location","fortuneAdmin","editableOptions",function(a,b,c,d){var e="";a.fortuneAdminRoute=function(a,b){return e+c.routePath(a,b)},d.theme="bs3"}]),function(){window.CONFIG||(window.CONFIG={}),window.CONFIG.fortuneAdmin={templateDirectory:"/templates/",baseEndpoint:"",apiNamespace:"/api/v1",getApiNamespace:function(){return this.baseEndpoint+this.apiNamespace},mountPoint:"",appVersion:1,viewUrlPrefix:"/templates/views/",templateFileSuffix:".html",prepareViewTemplateUrl:function(a){return this.viewUrlPrefix+a+this.templateFileSuffix},routing:{html5Mode:!0,prefix:""},authToken:""}}(),angular.module("fortuneAdmin.Controllers",["fortuneAdmin.Services","fortuneAdmin.Controllers.umlDiagram"]).filter("filterLinks",[function(){return function(a){var b={};return angular.forEach(a,function(a,c){angular.isObject(a)||(b[c]=a)}),b}}]).controller("ResourcesCtrl",["$scope","$http","Inflect","$routeParams","resources","data",function(a,b,c,d,e,f){var g={};angular.forEach(e,function(a){(a.name===d.name||c.pluralize(a.name)===d.name)&&(g=a)}),angular.forEach(g.schema,function(a,b){angular.isObject(a)&&!angular.isArray(a)&&(a.type?g.schema[b]=a.type:delete g.schema[b])});var h=c.pluralize(g.name);a.plurResourceName=h,a.currentResource=g,a.data=f[h],a.links=f.links,a.PK=a.currentResource.modelOptions?a.currentResource.modelOptions.pk||"id":"id",a.parentResourceName=d.parent,a.parentId=d.id,this.resolveFieldName=function(a){var b=a.split(".");return b[b.length-1]},this.resolveInverse=function(a){var b=this.resolveFieldName(a),c=g.schema[b],d="";if(angular.isArray(c))d=c[0].inverse;else{if(!angular.isObject(c))throw new Error("Malformed reference");d=c.inverse}return d},this.linkToMany=function(a){var b=this.resolveFieldName(a),c=g.schema[b];return angular.isArray(c)},this.addRow=function(c){var e={};if("id"!==a.PK&&(e[a.PK]=c),d.id){var f=d.inverse;e[f]=angular.isArray(a.currentResource.schema[f])?[d.id]:d.id}var g={};g[h]=[e];var i={params:{userAuthToken:CONFIG.fortuneAdmin.authToken}};b.post(CONFIG.fortuneAdmin.getApiNamespace()+"/"+h,g,i).success(function(b){a.data.push(b[h][0])})},this.deleteRow=function(c,d){var e={params:{userAuthToken:CONFIG.fortuneAdmin.authToken}};b.delete(CONFIG.fortuneAdmin.getApiNamespace()+"/"+h+"/"+d,e).success(function(){a.data.splice(c,1)}).error(function(a,b){console.error(a,b)})}}]),angular.module("fortuneAdmin.Controllers.umlDiagram",["fortuneAdmin.umlDiagram.services"]).controller("umlDiagramCtrl",["$scope","umlData","$timeout",function(a,b,c){a.resources=[],a.selected=[],a.allSelected=!1,a.build=!0,b.load().then(function(b){angular.forEach(b,function(a){a.$schemaLength=Object.keys(a.schema).length}),a.resources=b},function(b){a.error=b}),this.toggleSelect=function(d){var e=a.selected.indexOf(d);-1===e?a.selected.push(d):a.selected.splice(e,1),b.destroy(),a.build=!1,c(function(){a.build=!0})},this.toggleSelectAll=function(){a.allSelected=!a.allSelected,a.selected=[],a.allSelected&&angular.forEach(a.resources,function(b){a.selected.push(b)}),angular.forEach(a.resources,function(b){b.$selected=a.allSelected})}}]),angular.module("fortuneAdmin.Directives",["fortuneAdmin.umlDiagram"]).directive("fortuneAdminNavbar",["$http","$rootScope","Inflect",function(a,b,c){return{restrict:"E",templateUrl:"/templates/views/mynavbar.html",replace:!0,transclude:!0,scope:{},link:function(d){d.r=b.fortuneAdminRoute,d.resources=[];var e={params:{userAuthToken:CONFIG.fortuneAdmin.authToken}};a.get(CONFIG.fortuneAdmin.baseEndpoint+"/resources",e).success(function(a){d.resources=a.resources}),d.pluralize=function(a){return c.pluralize(a)}}}}]).controller("faEditableCtrl",["$scope","$http",function(a,b){a.apply=function(c){var d=[];d.push({op:"replace",path:"/"+a.resourceName+"/0/links/"+a.path,value:c}),b({method:"PATCH",url:CONFIG.fortuneAdmin.getApiNamespace()+"/"+a.resourceName+"/"+a.resourceId,data:d,params:{userAuthToken:CONFIG.fortuneAdmin.authToken}}).catch(function(a,b){console.error(a,b)})}}]).directive("faEditable",[function(){return{restrict:"E",replace:!0,scope:{value:"=ngModel",path:"=",schemaType:"=",resourceName:"@",resourceId:"@"},templateUrl:"/templates/directives/faEditable.html",controller:"faEditableCtrl"}}]).directive("faRef",["$http","$compile","Inflect",function(a,b,c){return{restrict:"E",replace:!1,scope:{value:"=ngModel",ref:"=",resourceName:"@",resourceId:"@"},controller:"faEditableCtrl",link:function(d,e){var f,g,h=d.path=d.ref.ref,i={params:{userAuthToken:CONFIG.fortuneAdmin.authToken}};a.get(CONFIG.fortuneAdmin.baseEndpoint+"/resources",i).success(function(j){f=j.resources,angular.forEach(f,function(a){a.name===h&&(g=a)}),a.get(CONFIG.fortuneAdmin.getApiNamespace()+"/"+c.pluralize(h),i).success(function(a){var f=g.modelOptions?g.modelOptions.pk||"id":"id";d.list=a[c.pluralize(h)];var i=['<a href="#" editable-select="value" ','e-ng-options="item.',f||"id"," as item.",f||"id",' for item in list" ','onaftersave="apply(value)">','{{ value || "Not set." }}',"</a>"],j=b(i.join(""))(d);e.append(j)})})}}}]),angular.module("fortuneAdmin.umlDiagram",["fortuneAdmin.umlDiagram.services"]).directive("umlCanvas",["umlData",function(a){var b;return{restrict:"E",replace:!0,scope:{id:"@",selectedResources:"="},templateUrl:"/templates/directives/uml/canvas.html",controller:["$scope","umlCanvasController",function(c,d){angular.extend(this,d),b=new joint.dia.Paper({el:$("#"+c.id),width:a._config.canvas.width,height:a._config.canvas.height,model:d.graph})}]}}]).directive("umlResource",["umlData",function(a){return{restrict:"E",require:"^umlCanvas",replace:!0,scope:{umlData:"="},templateUrl:"/templates/directives/uml/resource.html",controller:function(b){b.umlData.modelOptions&&b.umlData.modelOptions.pk&&delete b.umlData.schema[b.umlData.modelOptions.pk];var c;b.$watch("umlData",function(){c={x:0,y:a._config.resource.height-a._config.field.height}}),this.embed=function(a){b.resource.embed(a)},this.intersects=function(a){return b.resource.getBBox().intersect(a.getBBox())},this.nextPostition=function(){return c.y+=a._config.field.height,c},b.$on("$destroy",function(){b.resource.remove()})},link:function(b,c,d,e){b.resource=new joint.shapes.basic.Rect({position:{x:0,y:0},size:{width:a._config.resource.width,height:a._config.resource.height},attrs:{rect:{fill:a._config.resource.bgColor},text:{text:"resource placeholder",fill:a._config.resource.textColor}}}),b.resource.intersects=function(a){return b.resource.getBBox().intersect(a.getBBox())},e.graph.addCell(b.resource),b.$watch("umlData",function(){b.resource.attr({text:{text:b.umlData.name}}),a.registerResource(b.umlData.name,b.resource),b.resource.set("inPorts",[b.umlData.name]);var c=a._config.resource.width+a._config.resource.minMarginX,d=0;e.moveResourceToFreePosition(b.resource,c,d)})}}}]).directive("umlField",["umlData","umlLinks","$timeout",function(a,b,c){return{restrict:"E",require:["^umlCanvas","^umlResource"],scope:{resource:"=",fieldName:"=",fieldData:"="},link:function(d,e,f,g){function h(){c(function(){if(angular.isArray(d.fieldData)){if(!d.fieldData[0])return console.error("empty array instead of reference");i(),b.link(d.field,d.fieldData[0].ref,!0)}else angular.isObject(d.fieldData)&&(i(),b.link(d.field,d.fieldData.ref,!1))})}function i(){d.field.attr({rect:{fill:a._config.field.bgColor},text:{text:"FK: "+d.fieldName+(d.fieldType?" ["+d.fieldType+"]":"")}})}var j=g[1],k=g[0];d.field=new joint.shapes.basic.Rect({position:j.nextPostition(),size:{width:a._config.field.width,height:a._config.field.height},attrs:{rect:{fill:f.isPk?a._config.field.pkColor:a._config.field.bgColor},text:{text:"undefined",fill:a._config.field.textColor}}}),d.field.intersects=function(a){return d.field.getBBox().intersect(a.getBBox())},j.embed(d.field),k.graph.addCell(d.field),d.$watch("fieldName",function(){if(d.fieldType=null,angular.isObject(d.fieldData)||angular.isArray(d.fieldData))d.fieldType="ref";else switch(d.fieldData){case"String":d.fieldType="str";break;case"Number":d.fieldType="num";break;case"Date":d.fieldType="date";break;case"Boolean":d.fieldType="bool";break;case"Array":d.fieldType="array";break;case"Buffer":d.fieldType="buff"}d.field.attr({text:{text:(f.isPk?"PK:"+d.fieldName:d.fieldName)+(d.fieldType?" ["+d.fieldType+"]":"")}})}),d.$watch("fieldData",h)}}}]),function(a){function b(a,b){a.resources=[],a.render=!1;var c={params:{userAuthToken:CONFIG.fortuneAdmin.authToken}};b.get(CONFIG.fortuneAdmin.baseEndpoint+"/resources",c).success(function(b){a.resources=b.resources,a.render=!0})}a.module("fortuneAdmin.Uml.Controllers",[]).controller("UmlCtrl",["$scope","$http",b])}(angular),function(a){a.module("fortuneAdmin.Uml.D3",[]).factory("d3",["$q","$timeout","$rootScope",function(a,b,c){var d=a.defer();return b(function(){c.$apply(function(){d.resolve(window.d3)})}),{load:function(){return d.promise}}}])}(angular),function(a){function b(b,c){return{restrict:"A",templateUrl:"/templates/directives/uml/canvas.html",scope:{resources:"="},link:function(d,e){function g(){for(var a=c.bottomLine[0],b=0,d=0;d<c.bottomLine.length;d++)c.bottomLine[d]<a&&(a=c.bottomLine[d],b=d);return[b,a]}function h(a,b){return c.positions[b]}c.clear(),d.canvas={};var i=[],j=[],k=0,l=Math.floor(e[0].clientWidth/f.columnWidth);a.forEach(d.resources,function(b,c){i[c]=[],j[c]={name:b.name},b.modelOptions&&b.modelOptions.pk&&(j[c].pk=b.modelOptions.pk||"id"),a.forEach(b.schema,function(a,b){i[c].push({name:b,params:a,pk:j[c].pk===b})}),i[c].sort(function(a,b){return a.name>b.name?1:-1})}),d.resources=i,function(){for(var b=0;l>b;b++)c.bottomLine.push(10);a.forEach(i,function(a,b){var d=a.length*f.fieldHeight+f.headerHeight,e=g(),h={x:e[0]*f.columnWidth,y:e[1],height:d,column:e[0]};c.bottomLine[e[0]]+=d+f.vgap,c.positions[b]=h})}();for(var m=0;m<c.bottomLine.length;m++)c.bottomLine[m]>k&&(k=c.bottomLine[m]+100);var n=d3.select(e[0]).append("svg").attr("id","mainCanvas").attr("height",k).style("width","100%"),o=n[0][0].offsetTop;c.setBase(o);{var p=n.selectAll("g").data(i).enter().append("g").attr("height",function(a){return a.length*f.fieldHeight}).attr("width",f.fieldWidth).attr("x",0).attr("y",0).attr("fill","#ffffff").append("foreignObject").attr("x",function(a,b){return h(a,b).x+f.vgap}).attr("y",function(a,b){return h(a,b).y}).attr("height",function(a){return a.length*f.fieldHeight+f.headerHeight}).attr("width",f.fieldWidth).append("xhtml:div").attr("class","resource");p.append("xhtml:div").attr("class","header").append("xhtml:h4").attr("class","text-center").text(function(a,b){return j[b].name})}p.append("xhtml:div").attr("style","width: 100%").append("xhtml:div").attr("resource-class","").attr("resource",function(a,b){return"resources["+b+"]"}),a.forEach(p[0],function(a){c.add("resources",a,a.innerText)}),e.removeAttr("resources-canvas"),b(e)(d)}}}function c(a){return{restrict:"A",scope:{resource:"="},link:function(b,c){{var d=b.resource.length*f.fieldHeight,e=d3.select(c[0]).append("svg").attr("width",f.fieldWidth).attr("height",d),g=0,h=-20;e.selectAll("g").data(b.resource).enter().append("g").attr("height",f.fieldHeight).attr("width",f.fieldWidth).attr("fill","#cccccc").append("foreignObject").attr("x",g).attr("y",function(){return h+=f.fieldHeight}).attr("height",f.fieldHeight).attr("width",f.fieldWidth).append("xhtml:div").attr("resource-property","").attr("field",function(a,b){return"resource["+b+"]"}).attr("class","text-center field").attr("style","width: 100%")}c.removeAttr("resource-class"),a(c)(b)}}}function d(b){return{restrict:"A",scope:{field:"=",isPk:"="},link:function(c,d){var e=!1;a.isArray(c.field.params)?c.field.params[0]&&c.field.params[0].ref&&(e=!0):a.isObject(c.field.params)&&c.field.params.ref&&(e=!0);var g={width:10,height:f.fieldHeight};if(e){var h=d3.select(d[0]).append("svg").attr("width",f.fieldWidth).attr("height",g.height);h.append("foreignObject").attr("width",f.fieldWidth).attr("height",f.fieldHeight).append("xhtml:div").attr("class","field ref").text(c.field.name+" [ref]"),h.append("foreignObject").attr("width",1).attr("height",f.fieldHeight).append("xhtml:div").attr("port-x",function(){return h[0][0].offsetLeft}).attr("port-y",function(){return h[0][0].offsetTop}).attr("resource-link","").attr("link-to-many",function(){return a.isArray(c.field.params)}).attr("link-to",function(){return a.isArray(c.field.params)?"field.params[0]":"field.params"})}else c.field.pk?(d.addClass("pk"),d.text("PK: "+c.field.name)):d.text(a.isArray(c.field.params)?c.field.name+" [Arr]":a.isObject(c.field.params)?c.field.name+" [Nested]":c.field.name+" ["+c.field.params.substr(0,3)+"]");d.removeAttr("resource-property"),b(d)(c)}}}function e(b){return{restrict:"A",scope:{linkToMany:"=",linkTo:"=",portX:"@",portY:"@"},link:function(c,d){function e(){var a=["#FF0020","#FF00CC","#0000FF","#00F9FF","#00FF20","#FFE000"],b=Math.floor(6*Math.random());return a[b]}var g=b.find("resources",c.linkTo.ref);if(g){var h=b.getBaseOffset(),i=parseInt(c.portX),j=parseInt(c.portY)+10,k=!1,l=i-g.right<100;i<=g.left&&(k=!0);var m=[];k?(m.push({x:i+f.fieldWidth,y:j-h}),m.push({x:i+f.fieldWidth+50,y:j-h})):l?(m.push({x:i+f.fieldWidth,y:j-h}),m.push({x:i+f.fieldWidth+50,y:j-h})):(m.push({x:i,y:j-h}),m.push({x:i-50,y:j-h}));var n=Math.floor((g.right-i)/f.columnWidth),o=Math.abs(n);if(o>1)for(var p=Math.floor(i/f.columnWidth),q=p+n,r=k?p+1:p-1;r!==q;){var s=[];a.forEach(b.positions,function(a){a.column==r&&s.push(a)});var t=s[0],u=Math.abs(j-t.y);a.forEach(s,function(a){var b=Math.abs(j-a.y);u>b&&(t=a,u=j-a.y)});var v=t.y+t.height+50*Math.random(),w=t.x,x=50;k?(m.push({x:w-x,y:v}),m.push({x:w+f.columnWidth-x,y:v})):(m.push({x:w+f.columnWidth+x,y:v}),m.push({x:w-x,y:v})),k?r++:r--}k?(m.push({x:g.left-50,y:g.top+10}),m.push({x:g.left,y:g.top+10})):(m.push({x:g.right+50,y:g.top+10}),m.push({x:g.right,y:g.top+10}));var y=d3.svg.line().x(function(a){return a.x}).y(function(a){return a.y}).tension(.95).interpolate("basis"),z=e(),A=d3.select("#mainCanvas").append("path").attr("d",y(m)).attr("stroke",z).attr("stroke-width",2).attr("fill","none").on("mouseover",function(){d3.select(this).attr("stroke","#F00").attr("stroke-width",10)}).on("mouseleave",function(){d3.select(this).attr("stroke",z).attr("stroke-width",2)}),B=d.parent().parent().parent();B.bind("mouseover",function(){A.attr("stroke","#F00").attr("stroke-width",10)}),B.bind("mouseleave",function(){A.attr("stroke",z).attr("stroke-width",2)})}}}}var f={headerHeight:50,fieldHeight:20,fieldWidth:200,columnWidth:300,vgap:50};a.module("fortuneAdmin.Uml.Directives",["fortuneAdmin.Uml.D3","fortuneAdmin.Uml.Services"]).directive("resourcesCanvas",["$compile","UmlElementsRegistry",b]).directive("resourceClass",["$compile","UmlElementsRegistry",c]).directive("resourceProperty",["$compile","UmlElementsRegistry",d]).directive("resourceLink",["UmlElementsRegistry",e])}(angular),function(a){a.module("fortuneAdmin.Uml",["fortuneAdmin.Uml.Controllers","fortuneAdmin.Uml.Services","fortuneAdmin.Uml.D3","fortuneAdmin.Uml.Directives"])}(angular),function(a){function b(){var b={resources:[],fields:[]},c=0;this.positions=[],this.bottomLine=[],this.setBase=function(a){c=a},this.getBaseOffset=function(){return c},this.add=function(a,d,e){e=e.replace(/\n/gi,""),b[a].push({id:e,top:d.offsetTop-c,left:d.offsetLeft,right:d.offsetLeft+d.clientWidth})},this.find=function(c,d){var e=null;return a.forEach(b[c],function(a){a.id===d&&(e=a)}),e},this.remove=function(){},this.clear=function(){b={resources:[],fields:[]},this.positions=[],this.bottomLine=[]}}a.module("fortuneAdmin.Uml.Services",[]).service("UmlElementsRegistry",[b])}(angular),angular.module("fortuneAdmin.Services.inflectPort",[]).service("Inflect",[function(){var a,b={},c=a={array:{del:function(a,b){var c=a.indexOf(b);return-1!=c?0==c?a.slice(1):a.slice(0,c).concat(a.slice(c+1)):a},first:function(a){return a[0]},last:function(a){return a[a.length-1]}},string:{gsub:function(b,c,d){var e,f,g,h,i,j,k;if(null==c||null==d)return a.string.value(b);for(j="",k=b;k.length>0;)if(f=k.match(c)){if(j+=k.slice(0,f.index),"function"==typeof d)f[1]=f[1]||f[0],j+=d(f);else if(d.match(/\$[1-9]/)){for(h=f,g=a.array.del(f,void 0);g!==h;)h=g,g=a.array.del(g,void 0);for(f[1]=f[1]||f[0],i=d,e=1;9>=e;e++)g[e]&&(i=a.string.gsub(i,new RegExp("\\$"+e),g[e]));j+=i}else j+=d;k=k.slice(f.index+f[0].length)}else j+=k,k="";return j},upcase:function(b){var c=a.string.gsub(b,/_([a-z])/,function(a){return"_"+a[1].toUpperCase()});return c=a.string.gsub(c,/\/([a-z])/,function(a){return"/"+a[1].toUpperCase()}),c[0].toUpperCase()+c.substr(1)},capitalize:function(b,c){var d=b.toLowerCase();return c||(d=a.string.gsub(d,/\s([a-z])/,function(a){return" "+a[1].toUpperCase()})),d[0].toUpperCase()+d.substr(1)},downcase:function(b){var c=a.string.gsub(b,/_([A-Z])/,function(a){return"_"+a[1].toLowerCase()});return c=a.string.gsub(c,/\/([A-Z])/,function(a){return"/"+a[1].toLowerCase()}),c[0].toLowerCase()+c.substr(1)},value:function(a){return a.substr(0)}}},d=function(a){a.plural(/$/,"s"),a.plural(/s$/i,"s"),a.plural(/(ax|test)is$/i,"$1es"),a.plural(/(octop|vir)us$/i,"$1i"),a.plural(/(octop|vir)i$/i,"$1i"),a.plural(/(alias|status)$/i,"$1es"),a.plural(/(bu)s$/i,"$1ses"),a.plural(/(buffal|tomat)o$/i,"$1oes"),a.plural(/([ti])um$/i,"$1a"),a.plural(/([ti])a$/i,"$1a"),a.plural(/sis$/i,"ses"),a.plural(/(?:([^f])fe|([lr])f)$/i,"$1ves"),a.plural(/(hive)$/i,"$1s"),a.plural(/([^aeiouy]|qu)y$/i,"$1ies"),a.plural(/(x|ch|ss|sh)$/i,"$1es"),a.plural(/(matr|vert|ind)(?:ix|ex)$/i,"$1ices"),a.plural(/([m|l])ouse$/i,"$1ice"),a.plural(/([m|l])ice$/i,"$1ice"),a.plural(/^(ox)$/i,"$1en"),a.plural(/^(oxen)$/i,"$1"),a.plural(/(quiz)$/i,"$1zes"),a.singular(/s$/i,""),a.singular(/(n)ews$/i,"$1ews"),a.singular(/([ti])a$/i,"$1um"),a.singular(/((a)naly|(b)a|(d)iagno|(p)arenthe|(p)rogno|(s)ynop|(t)he)ses$/i,"$1sis"),a.singular(/(^analy)ses$/i,"$1sis"),a.singular(/([^f])ves$/i,"$1fe"),a.singular(/(hive)s$/i,"$1"),a.singular(/(tive)s$/i,"$1"),a.singular(/([lr])ves$/i,"$1f"),a.singular(/([^aeiouy]|qu)ies$/i,"$1y"),a.singular(/(s)eries$/i,"$1eries"),a.singular(/(m)ovies$/i,"$1ovie"),a.singular(/(x|ch|ss|sh)es$/i,"$1"),a.singular(/([m|l])ice$/i,"$1ouse"),a.singular(/(bus)es$/i,"$1"),a.singular(/(o)es$/i,"$1"),a.singular(/(shoe)s$/i,"$1"),a.singular(/(cris|ax|test)es$/i,"$1is"),a.singular(/(octop|vir)i$/i,"$1us"),a.singular(/(alias|status)es$/i,"$1"),a.singular(/^(ox)en/i,"$1"),a.singular(/(vert|ind)ices$/i,"$1ex"),a.singular(/(matr)ices$/i,"$1ix"),a.singular(/(quiz)zes$/i,"$1"),a.singular(/(database)s$/i,"$1"),a.irregular("child","children"),a.irregular("person","people"),a.irregular("man","men"),a.irregular("child","children"),a.irregular("sex","sexes"),a.irregular("move","moves"),a.irregular("cow","kine"),a.irregular("zombie","zombies"),a.uncountable(["equipment","information","rice","money","species","series","fish","sheep","jeans"])},e=function(){return this.plurals=[],this.singulars=[],this.uncountables=[],this.humans=[],d(this),this};return e.prototype.plural=function(a,b){"string"==typeof a&&(this.uncountables=c.array.del(this.uncountables,a)),this.uncountables=c.array.del(this.uncountables,b),this.plurals.unshift([a,b])},e.prototype.singular=function(a,b){"string"==typeof a&&(this.uncountables=c.array.del(this.uncountables,a)),this.uncountables=c.array.del(this.uncountables,b),this.singulars.unshift([a,b])},e.prototype.irregular=function(a,b){this.uncountables=c.array.del(this.uncountables,a),this.uncountables=c.array.del(this.uncountables,b),a[0].toUpperCase()==b[0].toUpperCase()?(this.plural(new RegExp("("+a[0]+")"+a.slice(1)+"$","i"),"$1"+b.slice(1)),this.plural(new RegExp("("+b[0]+")"+b.slice(1)+"$","i"),"$1"+b.slice(1)),this.singular(new RegExp("("+b[0]+")"+b.slice(1)+"$","i"),"$1"+a.slice(1))):(this.plural(new RegExp(""+a[0].toUpperCase()+a.slice(1)+"$"),b[0].toUpperCase()+b.slice(1)),this.plural(new RegExp(""+a[0].toLowerCase()+a.slice(1)+"$"),b[0].toLowerCase()+b.slice(1)),this.plural(new RegExp(""+b[0].toUpperCase()+b.slice(1)+"$"),b[0].toUpperCase()+b.slice(1)),this.plural(new RegExp(""+b[0].toLowerCase()+b.slice(1)+"$"),b[0].toLowerCase()+b.slice(1)),this.singular(new RegExp(""+b[0].toUpperCase()+b.slice(1)+"$"),a[0].toUpperCase()+a.slice(1)),this.singular(new RegExp(""+b[0].toLowerCase()+b.slice(1)+"$"),a[0].toLowerCase()+a.slice(1)))},e.prototype.human=function(a,b){this.humans.unshift([a,b])},e.prototype.uncountable=function(a){this.uncountables=this.uncountables.concat(a)},e.prototype.clear=function(a){switch(null==a&&(a="all"),a){case"all":this.plurals=[],this.singulars=[],this.uncountables=[],this.humans=[];default:this[a]=[]}},e.prototype.default=function(){return this.plurals=[],this.singulars=[],this.uncountables=[],this.humans=[],d(this),this},b.inflections=new e,b.inflect=function(a){a(b.inflections)},b.camelize=function(a,b){var d;return null==b&&(b=!0),d=c.string.gsub(a,/\/(.?)/,function(a){return"."+c.string.upcase(a[1])}),d=c.string.gsub(d,/(?:_)(.)/,function(a){return c.string.upcase(a[1])}),b?c.string.upcase(d):c.string.downcase(d)},b.underscore=function(a){var b;return b=c.string.gsub(a,/\./,"/"),b=c.string.gsub(b,/([A-Z]+)([A-Z][a-z])/,"$1_$2"),b=c.string.gsub(b,/([a-z\d])([A-Z])/,"$1_$2"),b=c.string.gsub(b,/-/,"_"),b.toLowerCase()},b.dasherize=function(a){return c.string.gsub(a,/_/,"-")},b.demodulize=function(a){return c.string.gsub(a,/^.*\./,"")},b.foreign_key=function(a,c){return null==c&&(c=!0),b.underscore(b.demodulize(a))+(c?"_id":"id")},b.ordinalize=function(a){var b;if(a=parseInt(a),11===(b=Math.abs(a)%100)||12===b||13===b)return""+a+"th";switch(Math.abs(a)%10){case 1:return""+a+"st";case 2:return""+a+"nd";case 3:return""+a+"rd";default:return""+a+"th"}},b.uncountability=function(a){return b.inflections.uncountables.some(function(b){return null!=a.match(new RegExp("(\\b|_)"+b+"$","i"))})},b.pluralize=function(a){var d,e;if(e=a,""===a||b.uncountability(a))return e;for(var f=0;f<b.inflections.plurals.length&&(d=b.inflections.plurals[f],e=c.string.gsub(e,d[0],d[1]),null==a.match(d[0]));f++);return e},b.singularize=function(a){var d,e;if(d=a,""===a||b.uncountability(a))return d;for(var f=0;f<b.inflections.singulars.length&&(e=b.inflections.singulars[f],d=c.string.gsub(d,e[0],e[1]),!a.match(e[0]));f++);return d},b.humanize=function(a){var d,e;e=a;for(var f=0;f<b.inflections.humans.length;f++)d=b.inflections.humans[f],e=c.string.gsub(e,d[0],d[1]);return e=c.string.gsub(e,/_id$/,""),e=c.string.gsub(e,/_/," "),c.string.capitalize(e,!0)},b.titleize=function(a){var d;return d=b.humanize(b.underscore(a)),d=c.string.gsub(d,/[^a-zA-Z:']/," "),c.string.capitalize(d)},b.tableize=function(a){return b.pluralize(b.underscore(a))},b.classify=function(a){return b.camelize(b.singularize(c.string.gsub(a,/.*\./,"")))},b}]),angular.module("fortuneAdmin.Services",["fortuneAdmin.Services.inflectPort"]),angular.module("fortuneAdmin.umlDiagram.services",[]).service("umlData",["$http","$q",function(a,b){this._config={canvas:{width:1140,height:7e3},resource:{minMarginX:100,minMarginY:50,width:200,height:50,bgColor:"black",textColor:"white"},field:{width:200,height:20,bgColor:"white",textColor:"black",pkColor:"green"}},this._resources={},this.load=function(){var c=b.defer(),d={params:{userAuthToken:CONFIG.fortuneAdmin.authToken}};return a.get(CONFIG.fortuneAdmin.baseEndpoint+"/resources",d).success(function(a){c.resolve(a.resources)}),c.promise},this.registerResource=function(a,b){this._resources[a]=b},this.getResource=function(a){return this._resources[a]},this.destroy=function(){this._resources={}}}]).service("umlCanvasController",["umlData",function(a){var b=this.graph=new joint.dia.Graph;this.rebuild=function(){b=this.graph=new joint.dia.Graph},this.moveResourceToFreePosition=function(c,d,e,f){function g(b){var c=null;angular.forEach(h,function(f){if(f.cid!==b.cid&&"link"!==f.attributes.type)for(;f.intersects(b);)c=b,i+=d,i>a._config.canvas.width?(b.translate(-i+d,j.getMaxResourceHeight(h)),i=0):b.translate(d,e)}),c&&g(c)}var h=f||b.attributes.cells.models,i=0,j=this;g(c)},this.getMaxResourceHeight=function(b){var c=0,d=a._config.resource.height,e=a._config.field.height;return angular.forEach(b,function(a){if(a.attributes.attrs.rect&&a.attributes.embeds){var b=d+e*a.attributes.embeds.length;b>c&&(c=b)}}),c+10}}]).service("umlLinks",["umlData","umlCanvasController",function(a,b){this.link=function(c,d,e){var f=a.getResource(d);if(!f)return c.attr({rect:{fill:"yellow"}});var g=new joint.dia.Link({source:{id:c.id},target:{id:f.id},router:{name:"manhattan"},connector:{name:"rounded"}});
g.attr({".connection":{stroke:e?"green":"blue"},".marker-target":{fill:"white",d:"M 10 0 L 0 5 L 10 10 z"}}),b.graph.addCell(g)}}]),function(a){a.module("fortuneAdmin.Standalone",["ngRoute","fortuneAdmin"]).config(["$routeProvider","$locationProvider","fortuneAdminProvider",function(a,b,c){c.mountTo(a,""),a.when("/",{templateUrl:"init.html",controller:"initCtrl"}),a.otherwise({redirectTo:"/uml"}),b.html5Mode(!0)}]).controller("initCtrl",["$scope","$location","fortuneAdmin",function(a,b,c){a.params={host:"",namespace:"/api/v1"},a.start=function(){c.setApiHost(a.params.host),c.setApiNamespace(a.params.namespace),b.url("/uml")}}])}(angular);